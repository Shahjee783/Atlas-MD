name: Marin VPS 

on:
  workflow_dispatch:
  repository_dispatch:

concurrency:
  group: marin-vps
  cancel-in-progress: true

permissions:
  actions: write
  contents: write

env:
  TZ: 'Asia/Kolkata'

jobs:
  ultimate-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 350

    steps:
    - name: ğŸ“‚ Checkout Code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.PAT_TOKEN }}
        fetch-depth: 0

    - name: ğŸŸ¢ Setup Node.js 22
      uses: actions/setup-node@v3
      with:
        node-version: '22'

    - name: ğŸ§¹ System Cleanup & Install Pro Tools
      run: |
        echo "ğŸ§¹ Clearing Disk Space..."
        sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost /usr/local/lib/android /opt/hostedtoolcache/CodeQL
        sudo docker image prune --all --force
        
        sudo apt-get update -qq
        sudo apt-get install -y -qq ffmpeg imagemagick webp jq tmate neofetch ttyd btop
        
        # Cloudflared Download & Install (Fixed Error)
        wget -q https://github.com
        sudo dpkg -i cloudflared-linux-amd64.deb
        
        sudo npm install -g pm2
        curl -fsSL https://raw.githubusercontent.com | sudo bash
        ssh-keygen -t ed25519 -N "" -f ~/.ssh/id_ed25519

    - name: ğŸ’¾ Setup Ghost Auto-Save (savecode)
      run: |
        git config --global user.email "marin-bot@auto.sync"
        git config --global user.name "Marin Auto-Saver"
        git remote set-url origin https://${{ secrets.PAT_TOKEN }}@://github.com{{ github.repository }}.git
        
        echo "**/node_modules/" >> .gitignore
        echo "**/*.log" >> .gitignore
        
        mv .github /tmp/.github_hidden
        
        echo '#!/bin/bash' > savecode
        echo 'echo "â³ Saving ALL BOTS to GitHub..."' >> savecode
        echo 'mv /tmp/.github_hidden ./.github' >> savecode 
        echo 'git add .' >> savecode
        echo 'git commit -m "ğŸ’¾ Auto-saved [skip ci]" || echo "No changes."' >> savecode
        echo 'git push origin HEAD || echo "Push failed."' >> savecode
        echo 'mv ./.github /tmp/.github_hidden' >> savecode 
        
        sudo mv savecode /usr/local/bin/savecode
        sudo chmod +x /usr/local/bin/savecode

    - name: ğŸš€ Auto-Detect & Start All Bots
      run: |
        BOT_LIST=""
        for dir in */ ; do
          if [ -d "$dir" ] && [ -f "$dir/package.json" ]; then
            BOT_NAME=$(basename "$dir")
            BOT_LIST="$BOT_LIST $BOT_NAME"
            cd "$dir"
            npm install --quiet
            if [ -f "index.js" ]; then
               pm2 start index.js --name "$BOT_NAME"
            else
               pm2 start npm --name "$BOT_NAME" -- start
            fi
            cd ..
          fi
        done
        echo "ACTIVE_BOTS=${BOT_LIST:-'No bots found'}" >> $GITHUB_ENV

    - name: ğŸŒ Open Web Panels
      run: |
        set +e 
        filebrowser -a 0.0.0.0 -p 8080 -r . --noauth > /tmp/cf_file.log 2>&1 &
        ttyd -R -p 61208 btop > /tmp/btop.log 2>&1 &
        sleep 3
        cloudflared tunnel --url http://127.0.0.1:8080 > /tmp/f_url.log 2>&1 &
        cloudflared tunnel --url http://127.0.0.1:61208 > /tmp/b_url.log 2>&1 &
        sleep 15
        echo "FILE_URL=$(grep -o 'https://[-a-zA-Z0-9]*\.trycloudflare\.com' /tmp/f_url.log | head -n 1)" >> $GITHUB_ENV
        echo "BTOP_URL=$(grep -o 'https://[-a-zA-Z0-9]*\.trycloudflare\.com' /tmp/b_url.log | head -n 1)" >> $GITHUB_ENV

    - name: ğŸ”„ Start Tmate & Discord Alert
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      run: |
        set +e 
        tmate -S /tmp/tmate.sock new-session -d
        tmate -S /tmp/tmate.sock wait tmate-ready
        SSH_MSG=$(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}')
        
        PAYLOAD=$(jq -n --arg ssh "$SSH_MSG" --arg f "$FILE_URL" --arg b "$BTOP_URL" --arg bots "$ACTIVE_BOTS" \
          '{content: "ğŸš¨ **VPS DASHBOARD** ğŸš¨\nğŸ¤– Bots: `\($bots)`\nğŸ“ Files: \($f)\nğŸ“Š Health: \($b)\nğŸ’» SSH: `\($ssh)`\n\n_ğŸ’¡ Save changes: `savecode`_"}')
        
        curl -H "Content-Type: application/json" -d "$PAYLOAD" $DISCORD_WEBHOOK
        
        # Wait for 5 hours 45 mins
        sleep 20700
        savecode || true

    - name: ğŸ§Ÿ Respawn Zombie
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.PAT_TOKEN }}
        script: |
          await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'marin.yml',
            ref: 'main'
          })
          
